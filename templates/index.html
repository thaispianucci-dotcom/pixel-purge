<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelClean</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f4f8;
            color: #1e293b;
            min-height: 100vh;
        }

        header {
            background: #fff;
            padding: 16px 40px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }

        header .logo {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }

        header h1 {
            font-size: 1.3rem;
            color: #1e40af;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        header p {
            color: #64748b;
            font-size: 0.8rem;
            margin-top: 1px;
        }

        .controls {
            background: #fff;
            padding: 16px 40px;
            display: flex;
            gap: 14px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid #e2e8f0;
        }

        .controls label {
            font-size: 0.82rem;
            color: #475569;
            font-weight: 500;
        }

        .controls input[type="range"] {
            width: 120px;
            accent-color: #2563eb;
        }

        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 48px 20px;
            text-align: center;
            margin: 24px 40px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fff;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: #2563eb;
            background: #eff6ff;
            box-shadow: 0 0 0 4px #2563eb15;
        }

        .drop-zone .icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .drop-zone p {
            color: #475569;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .drop-zone .hint {
            color: #94a3b8;
            font-size: 0.75rem;
        }

        .drop-zone.has-files {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .file-count {
            color: #1e40af;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-primary {
            background: #2563eb;
            color: #fff;
        }
        .btn-primary:hover { background: #1d4ed8; }

        .btn-danger {
            background: #dc2626;
            color: #fff;
        }
        .btn-danger:hover { background: #b91c1c; }

        .status-bar {
            padding: 10px 40px;
            background: #fff;
            font-size: 0.82rem;
            border-bottom: 1px solid #e2e8f0;
            display: none;
            color: #475569;
        }

        .status-bar.visible { display: block; }

        .progress-bar {
            margin: 0 40px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }

        .progress-bar.visible { display: block; }

        .progress-bar .fill {
            height: 100%;
            background: #2563eb;
            width: 0%;
            transition: width 0.3s;
        }

        .loading {
            text-align: center;
            padding: 60px;
            display: none;
            color: #475569;
        }

        .loading.visible { display: block; }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .results { padding: 24px 40px; }

        .group {
            background: #fff;
            border-radius: 12px;
            margin-bottom: 24px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .group-header {
            padding: 14px 20px;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 0.88rem;
            color: #1e40af;
            border-bottom: 1px solid #e2e8f0;
        }

        .group-header .select-actions {
            display: flex;
            gap: 8px;
        }

        .group-header button {
            background: #fff;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.15s;
        }

        .group-header button:hover { border-color: #2563eb; color: #2563eb; background: #eff6ff; }

        .group-images {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding: 16px 20px;
        }

        .image-card {
            position: relative;
            background: #f8fafc;
            border-radius: 10px;
            overflow: hidden;
            width: 220px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .image-card:hover { border-color: #cbd5e1; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .image-card.selected { border-color: #2563eb; box-shadow: 0 0 0 3px #2563eb25; }

        .image-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
            cursor: pointer;
        }

        .image-card .info {
            padding: 10px 12px;
            font-size: 0.72rem;
            color: #64748b;
        }

        .image-card .info .filename {
            color: #1e293b;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 3px;
        }

        .image-card .checkbox-area {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 2;
        }

        .image-card .checkbox-area input {
            width: 20px;
            height: 20px;
            accent-color: #2563eb;
            cursor: pointer;
        }

        .delete-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-top: 1px solid #e2e8f0;
            padding: 14px 40px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.06);
            color: #1e293b;
        }

        .delete-bar.visible { display: flex; }

        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: #94a3b8;
            display: none;
        }

        .empty-state.visible { display: block; }
        .empty-state h2 { color: #64748b; margin-bottom: 8px; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .modal-overlay.visible { display: flex; }

        .modal-overlay img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<header>
    <svg class="logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="5" y="5" width="90" height="90" rx="14" fill="#2563eb" opacity="0.1"/>
        <rect x="5" y="5" width="90" height="90" rx="14" stroke="#2563eb" stroke-width="2" fill="none"/>
        <rect x="22" y="30" width="26" height="20" rx="3" stroke="#2563eb" stroke-width="2" fill="#2563eb" opacity="0.15"/>
        <rect x="52" y="30" width="26" height="20" rx="3" stroke="#2563eb" stroke-width="2" fill="#2563eb" opacity="0.15"/>
        <circle cx="35" cy="38" r="3" fill="#2563eb" opacity="0.5"/>
        <circle cx="65" cy="38" r="3" fill="#2563eb" opacity="0.5"/>
        <line x1="42" y1="40" x2="52" y2="40" stroke="#2563eb" stroke-width="2" stroke-dasharray="3 2"/>
        <path d="M40 60 L50 68 L72 42" stroke="#2563eb" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <div>
        <h1>PixelClean</h1>
        <p>Encontre e remova fotos duplicadas</p>
    </div>
</header>

<div class="controls">
    <label>
        Sensibilidade: <span id="thresholdValue">10</span>
        <input type="range" id="threshold" min="1" max="25" value="10">
    </label>
    <button class="btn btn-primary" id="scanBtn" onclick="startScan()" disabled>Escanear</button>
</div>

<div id="dropZone" class="drop-zone">
    <div class="icon">&#128247;</div>
    <p>Arraste suas fotos aqui</p>
    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 12px;">
        <button class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('fileInput').click();">Selecionar Fotos</button>
        <button class="btn" style="background: #e2e8f0; color: #475569;" onclick="event.stopPropagation(); document.getElementById('folderInput').click();">Selecionar Pasta</button>
    </div>
    <div class="hint" style="margin-top: 10px;">Formatos aceitos: JPG, PNG, BMP, WEBP, GIF, TIFF</div>
    <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
    <input type="file" id="folderInput" webkitdirectory multiple style="display:none">
</div>

<div class="progress-bar" id="progressBar">
    <div class="fill" id="progressFill"></div>
</div>

<div class="status-bar" id="statusBar"></div>

<div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Processando imagens e calculando similaridade...</p>
</div>

<div class="empty-state" id="emptyState">
    <h2>Nenhum grupo de fotos semelhantes encontrado</h2>
    <p>Tente ajustar a sensibilidade ou envie mais fotos.</p>
</div>

<div class="results" id="results"></div>

<div class="delete-bar" id="deleteBar">
    <span id="deleteCount">0 fotos selecionadas</span>
    <button class="btn btn-danger" onclick="deleteSelected()">Remover Selecionadas</button>
</div>

<div class="modal-overlay" id="modal" onclick="closeModal()">
    <img id="modalImg" src="" alt="">
</div>

<script>
    const thresholdSlider = document.getElementById('threshold');
    const thresholdValue = document.getElementById('thresholdValue');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const folderInput = document.getElementById('folderInput');
    const scanBtn = document.getElementById('scanBtn');

    thresholdSlider.addEventListener('input', () => {
        thresholdValue.textContent = thresholdSlider.value;
    });

    let uploadedFiles = [];
    let allGroups = [];
    let selectedFiles = new Set();
    let currentSessionId = '';

    // --- Drop zone ---
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', () => {
        handleFiles(fileInput.files);
    });

    folderInput.addEventListener('change', () => {
        handleFiles(folderInput.files);
    });

    function handleFiles(files) {
        const imageExts = ['.jpg', '.jpeg', '.png', '.bmp', '.webp', '.gif', '.tiff', '.tif'];
        uploadedFiles = Array.from(files).filter(f => {
            const ext = f.name.substring(f.name.lastIndexOf('.')).toLowerCase();
            return imageExts.includes(ext);
        });
        if (uploadedFiles.length > 0) {
            dropZone.classList.add('has-files');
            dropZone.innerHTML = `
                <div class="file-count">${uploadedFiles.length} foto(s) selecionada(s)</div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 12px;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('fileInput2').click();">Trocar Fotos</button>
                    <button class="btn" style="background: #e2e8f0; color: #475569;" onclick="event.stopPropagation(); document.getElementById('folderInput2').click();">Trocar Pasta</button>
                </div>
                <input type="file" id="fileInput2" multiple accept="image/*" style="display:none">
                <input type="file" id="folderInput2" webkitdirectory multiple style="display:none">
            `;
            document.getElementById('fileInput2').addEventListener('change', function() { handleFiles(this.files); });
            document.getElementById('folderInput2').addEventListener('change', function() { handleFiles(this.files); });
            scanBtn.disabled = false;
        }
    }

    function imageUrl(filename) {
        return `/image/${currentSessionId}/${encodeURIComponent(filename)}`;
    }

    async function startScan() {
        if (uploadedFiles.length === 0) {
            alert('Selecione fotos primeiro.');
            return;
        }

        scanBtn.disabled = true;
        document.getElementById('results').innerHTML = '';
        document.getElementById('statusBar').classList.remove('visible');
        document.getElementById('emptyState').classList.remove('visible');
        document.getElementById('deleteBar').classList.remove('visible');
        selectedFiles.clear();

        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        progressBar.classList.add('visible');
        progressFill.style.width = '0%';

        const formData = new FormData();
        uploadedFiles.forEach(f => formData.append('files', f));
        formData.append('threshold', thresholdSlider.value);

        try {
            const xhr = new XMLHttpRequest();
            const response = await new Promise((resolve, reject) => {
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        progressFill.style.width = pct + '%';
                    }
                });

                xhr.addEventListener('load', () => {
                    progressBar.classList.remove('visible');
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        const err = JSON.parse(xhr.responseText);
                        reject(new Error(err.error || 'Erro no servidor'));
                    }
                });

                xhr.addEventListener('error', () => {
                    progressBar.classList.remove('visible');
                    reject(new Error('Erro de conexão'));
                });

                xhr.upload.addEventListener('loadend', () => {
                    progressFill.style.width = '100%';
                    document.getElementById('loading').classList.add('visible');
                });

                xhr.open('POST', '/upload');
                xhr.send(formData);
            });

            document.getElementById('loading').classList.remove('visible');

            currentSessionId = response.session_id;
            allGroups = response.groups;

            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = `${response.total_images} imagens enviadas | ${response.total_groups} grupo(s) de fotos semelhantes`;
            statusBar.classList.add('visible');

            if (response.total_groups === 0) {
                document.getElementById('emptyState').classList.add('visible');
            } else {
                renderGroups(response.groups);
            }
        } catch (e) {
            document.getElementById('loading').classList.remove('visible');
            progressBar.classList.remove('visible');
            alert('Erro: ' + e.message);
        } finally {
            scanBtn.disabled = false;
        }
    }

    function renderGroups(groups) {
        const container = document.getElementById('results');
        container.innerHTML = '';

        groups.forEach((group, gi) => {
            const div = document.createElement('div');
            div.className = 'group';
            div.innerHTML = `
                <div class="group-header">
                    <span>Grupo ${gi + 1} — ${group.length} fotos semelhantes</span>
                    <div class="select-actions">
                        <button onclick="selectAllButBest(${gi})">Manter melhor</button>
                        <button onclick="selectNone(${gi})">Limpar</button>
                    </div>
                </div>
                <div class="group-images" id="group-${gi}">
                    ${group.map((img, ii) => `
                        <div class="image-card" id="card-${gi}-${ii}">
                            <div class="checkbox-area">
                                <input type="checkbox" onchange="toggleSelect(${gi}, ${ii})"
                                       id="cb-${gi}-${ii}">
                            </div>
                            <img src="${imageUrl(img.path)}" alt="${img.filename}"
                                 onclick="openModal('${escPath(img.path)}')" loading="lazy">
                            <div class="info">
                                <div class="filename" title="${img.filename}">${img.filename}</div>
                                <div>${img.resolution} | ${img.size} | ${img.modified}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(div);
        });
    }

    function escPath(p) {
        return p.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    }

    function toggleSelect(gi, ii) {
        const path = allGroups[gi][ii].path;
        const cb = document.getElementById(`cb-${gi}-${ii}`);
        const card = document.getElementById(`card-${gi}-${ii}`);

        if (cb.checked) {
            selectedFiles.add(path);
            card.classList.add('selected');
        } else {
            selectedFiles.delete(path);
            card.classList.remove('selected');
        }
        updateDeleteBar();
    }

    function selectAllButBest(gi) {
        const group = allGroups[gi];
        group.forEach((img, ii) => {
            const cb = document.getElementById(`cb-${gi}-${ii}`);
            const card = document.getElementById(`card-${gi}-${ii}`);
            if (ii === 0) {
                cb.checked = false;
                card.classList.remove('selected');
                selectedFiles.delete(img.path);
            } else {
                cb.checked = true;
                card.classList.add('selected');
                selectedFiles.add(img.path);
            }
        });
        updateDeleteBar();
    }

    function selectNone(gi) {
        const group = allGroups[gi];
        group.forEach((img, ii) => {
            const cb = document.getElementById(`cb-${gi}-${ii}`);
            const card = document.getElementById(`card-${gi}-${ii}`);
            cb.checked = false;
            card.classList.remove('selected');
            selectedFiles.delete(img.path);
        });
        updateDeleteBar();
    }

    function updateDeleteBar() {
        const bar = document.getElementById('deleteBar');
        const count = document.getElementById('deleteCount');
        if (selectedFiles.size > 0) {
            bar.classList.add('visible');
            count.textContent = `${selectedFiles.size} foto(s) selecionada(s)`;
        } else {
            bar.classList.remove('visible');
        }
    }

    async function deleteSelected() {
        if (selectedFiles.size === 0) return;

        const confirmed = confirm(
            `Remover ${selectedFiles.size} foto(s) duplicadas?\n\nAs fotos serão removidas do servidor.`
        );
        if (!confirmed) return;

        try {
            const resp = await fetch('/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    files: Array.from(selectedFiles)
                })
            });
            const data = await resp.json();

            if (data.deleted.length > 0) {
                alert(`${data.deleted.length} foto(s) removida(s).`);
                const deletedSet = new Set(data.deleted);
                for (let gi = allGroups.length - 1; gi >= 0; gi--) {
                    allGroups[gi] = allGroups[gi].filter(img => !deletedSet.has(img.path));
                }
                selectedFiles.clear();
                allGroups = allGroups.filter(g => g.length > 1);
                renderGroups(allGroups);
                updateDeleteBar();

                const statusBar = document.getElementById('statusBar');
                statusBar.textContent = `${allGroups.length} grupo(s) restante(s) | ${data.deleted.length} foto(s) removida(s)`;
                if (allGroups.length === 0) {
                    document.getElementById('emptyState').classList.add('visible');
                    statusBar.textContent = 'Todas as duplicatas foram resolvidas!';
                }
            }
            if (data.errors.length > 0) {
                alert('Alguns erros ocorreram:\n' + data.errors.join('\n'));
            }
        } catch (e) {
            alert('Erro: ' + e.message);
        }
    }

    function openModal(path) {
        document.getElementById('modalImg').src = imageUrl(path);
        document.getElementById('modal').classList.add('visible');
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('visible');
    }
</script>

</body>
</html>
